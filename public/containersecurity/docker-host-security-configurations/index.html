<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Demestifying Container and Orchestration Ecosystem">
<meta name="author" content="CloudNativeFolks">

<title>Docker host security configurations · kubedaily</title>

<link rel="canonical" href="https://kubedaily.com/containersecurity/docker-host-security-configurations/">









<link rel="stylesheet" href="/scss/base.css" integrity="">



<link rel="stylesheet" href="/scss/theme/default.css" integrity="">



  <link rel="preconnect" href="https://-dsn.algolia.net" crossorigin />
  
  <link rel="stylesheet" href="/scss/component/docsearch.css" integrity=""/>

<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/img/icon/favicon.ico">
<link rel="icon" href="/img/icon/icon-16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/img/icon/icon-32.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/img/icon/icon-180.png" sizes="180x180">
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', '');
</script>
    <script 
     src="https://cdn.jsdelivr.net/npm/quizdown@latest/public/build/quizdown.js">
  </script>
  <script 
      src="https://cdn.jsdelivr.net/npm/quizdown@latest/public/build/extensions/quizdownKatex.js">
  </script>
  <script 
      src="https://cdn.jsdelivr.net/npm/quizdown@latest/public/build/extensions/quizdownHighlight.js">
  </script>
  <script>quizdown.register(quizdownHighlight).register(quizdownKatex).init()</script> 
  </head>
  <body>
    <header id="site-header">
  
  <div id="site-header-brand">
    <a href="/">kubedaily</a>
  </div>

  
  <div id="site-header-controls">
    
    <div class="dropdown">
      <button class="dropdown-btn" aria-haspopup="menu" aria-label="theme selector">
        <i class="icon icon-brightness"></i>
        <i class="icon icon-select"></i>
      </button>
      <ul role="menu" class="dropdown-menu">
        <li role="menuitem"><button class="color-scheme" data-value="light"><i class="icon icon-light-mode"></i> Light</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="dark"><i class="icon icon-dark-mode"></i> Dark &nbsp;</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="night"><i class="icon icon-night-mode"></i> Night</button></li>
      </ul>
    </div>

    
    <div class="dropdown">
      <button class="dropdown-btn" aria-haspopup="menu" aria-label="language selector">
        <i class="icon icon-translate"></i>
        <i class="icon icon-select"></i>
      </button>
      <ul role="menu" class="dropdown-menu">
        
          <li role="menuitem"><a href="#">English</a></li>
        
      </ul>
    </div>
  </div>

  
  <div id="site-header-menu">
    <nav>
      <ul>
        
        
        
          
          <li><a href="/" ><i class='icon icon-home'></i>Home</a></li>
        
          
          <li><a href="/docker/" ><i class='icon icons8-docker '></i>Docker</a></li>
        
          
          <li><a href="/containersecurity/"  class="active"><i class='icon icon-book'></i>ContainerSecurity</a></li>
        
          
          <li><a href="/k8s/" ><i class='icon icons8-kubernetes'></i>Kubernetes</a></li>
        
          
          <li><a href="/blog/" ><i class='icon icon-book'></i>blog</a></li>
        
          
          <li><a href="https://kubedaily.com/cloudnativetools/" ><i class='icon icon-book'></i>cloudnativetools</a></li>
        
      </ul>
    </nav>
  </div>

  

</header>
    
<div id="site-main-content-wrapper">
  
  
    <aside id="sidebar">
  <span class="btn-close"><i class="icon icon-close"></i></span>

  <div class="sticky"><strong class="sidebar-section">Container Security</strong>
          
          <a class="sidebar-link " href="/containersecurity/overview/">
            
              Overview
            
          </a>

        <strong class="sidebar-section">🔒ContainerSecurity</strong>
          
          <a class="sidebar-link " href="/containersecurity/what-is-container/">
            
              What is container?
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/container-vs-virtualization/">
            
              Container vs Virtualization
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/namespaces/">
            
              Namespaces
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/cgroups/">
            
              Cgroups
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/capabilities/">
            
              Capabilities
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-architecture-and-its-components/">
            
              Docker architecture and its components
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/interacting-with-container-ecosystem/">
            
              Interacting with container ecosystem
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/attack-surface-of-the-container-ecosystem/">
            
              Attack surface of the container ecosystem
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-volumes/">
            
              Docker volumes
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-networking/">
            
              Docker Networking
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/auditing-docker-security/">
            
              Auditing Docker Security
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/container-image-security/">
            
              Container Image Security
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/dockerfile-security-best-practices/">
            
              DockerFile Security Best Practices
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/secretscanner-finding-secrets-and-passwords-in-container-images-and-file-systems/">
            
              SecretScanner - Finding secrets and passwords in container images and file systems
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/yarahunter-malware-scanner-for-container-images/">
            
              YaraHunter - Malware Scanner for Container Images
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/security-linting-of-dockerfiles/">
            
              Security Linting of Dockerfiles
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/static-analysis-of-container-images-library-for-container/">
            
              Static Analysis of container images library for container
            
          </a>

        
          
          <a class="sidebar-link current" href="/containersecurity/docker-host-security-configurations/">
            
              Docker host security configurations
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-daemon-security-configurations/">
            
              Docker Daemon security configurations
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/content-trust-and-integrity-checks/">
            
              Content Trust and Integrity checks
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-registry-security-configurations/">
            
              Docker Registry security configurations
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/dockerscan/">
            
              DockerScan
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/dive/">
            
              Dive
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity/docker-events/">
            
              Docker events
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity//">
            
              
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity//">
            
              
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity//">
            
              
            
          </a>

        
          
          <a class="sidebar-link " href="/containersecurity//">
            
              
            
          </a>

        
  </div>
</aside>
  
  <main>
    <article id="article">
      <nav id="article-nav">
  <button id="article-nav-menu-btn"><i class="icon icon-menu"></i> On this section</button>
  <button id="article-nav-toc-btn"><i class="icon icon-toc"></i> On this page</button>
</nav>
      <header id="article-header">
  <h1>Docker host security configurations</h1>
</header>
      <div id="article-content">
        
        
        <h2 id="seccomp-and-apparmor">SecComp and AppArmor</h2>
<p>Docker works with major Linux MAC technologies such as AppArmor and SELinux.</p>
<p>Depending on your Linux distribution, Docker applies a default AppArmor profile to all new containers. According to the Docker documentation, this default profile is “moderately protective while providing wide application compatibility”.</p>
<p>Docker also lets you start containers without a policy applied, as well as giving you the ability to customize policies to meet specific requirements. This is also very powerful, but can also be prohibitively complex.</p>
<h2 id="seccomp">seccomp</h2>
<p>Docker uses seccomp, in filter mode, to limit the syscalls a container can make to the host’s kernel.</p>
<p>As per the Docker security philosophy, all new containers get a default seccomp profile configured with sensible defaults. This is intended to provide moderate security without impacting application compatibility.</p>
<p><img src="./images/seccomp.png" alt=""></p>
<p>As always, you can customize seccomp profiles, and you can pass a flag to Docker so that containers can be started without a seccomp profile.</p>
<p>As with many of the technologies already mentioned, seccomp is extremely powerful. However, the Linux syscall table is long, and configuring the appropriate seccomp policies can be prohibitively complex.</p>
<h1 id="concluding-linux-security-technologies">Concluding Linux security technologies</h1>
<p>Docker supports most of the important Linux security technologies and ships with sensible defaults that add security but aren’t too restrictive. The figure below shows how these technologies form multiple layers of potential security.</p>
<p>Some of these technologies can be complicated to customize as they require deep knowledge of how the Linux kernel works. Hopefully, they will get simpler to configure in the future, but for now, the default configurations that ship with Docker might be a good place to start.</p>
<h2 id="seccomp-exercise-1">SecComp Exercise 1</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grep SECCOMP /boot/config-<span class="k">$(</span>uname -r<span class="k">)</span>
</span></span></code></pre></div><p>get the fitst test for seccomp in strict mode</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-seccomp_strict.c" data-lang="seccomp_strict.c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/seccomp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">output</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;output.txt&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="s">&#34;test&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Calling prctl() to set seccomp strict mode...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">prctl</span><span class="p">(</span><span class="n">PR_SET_SECCOMP</span><span class="p">,</span> <span class="n">SECCOMP_MODE_STRICT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Writing to an already open file...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Trying to open file for reading...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">input</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;output.txt&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You will not see this message--the process will be killed first</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gcc seccomp_stric.c -o seccomp_strict 
</span></span><span class="line"><span class="cl">./seccomp_strict
</span></span></code></pre></div><p>open()system call is not allowed by secccomp strict mode</p>
<p>get the file ro test for seccomp in filter mode</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;seccomp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* initialize the libseccomp context */</span>
</span></span><span class="line"><span class="cl">    <span class="n">scmp_filter_ctx</span> <span class="n">ctx</span> <span class="o">=</span> <span class="nf">seccomp_init</span><span class="p">(</span><span class="n">SCMP_ACT_KILL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* allow exiting */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="nf">SCMP_SYS</span><span class="p">(</span><span class="n">exit_group</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* allow getting the current pid */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="nf">SCMP_SYS</span><span class="p">(</span><span class="n">getpid</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* allow changing data segment size, as required by glibc */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="nf">SCMP_SYS</span><span class="p">(</span><span class="n">brk</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* allow writing up to 512 bytes to fd 1 */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SCMP_ACT_ALLOW</span><span class="p">,</span> <span class="nf">SCMP_SYS</span><span class="p">(</span><span class="n">write</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SCMP_A0</span><span class="p">(</span><span class="n">SCMP_CMP_EQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SCMP_A2</span><span class="p">(</span><span class="n">SCMP_CMP_LE</span><span class="p">,</span> <span class="mi">512</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* if writing to any other fd, return -EBADF */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_rule_add</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nf">SCMP_ACT_ERRNO</span><span class="p">(</span><span class="n">EBADF</span><span class="p">),</span> <span class="nf">SCMP_SYS</span><span class="p">(</span><span class="n">write</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nf">SCMP_A0</span><span class="p">(</span><span class="n">SCMP_CMP_NE</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* load and enforce the filters */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_load</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">seccomp_release</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;this process is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>we have first initiazed the seccomp in filter mode . previouly have used <code>prctl(PR_SET_SECCOMP, SECCOMP_MODE_STRICT);</code> to set the seccomp in strict mode .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gcc seccomp_bpf.c -o seccomp_bpf
</span></span></code></pre></div><p>install libseccomp-dev</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt-get install libseccomp-dev
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gcc seccomp_bpf.c -o seccomp_bpf -lseccomp
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./seccomp_bpf
</span></span></code></pre></div><p>output</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">initiating seccomp ...
</span></span><span class="line"><span class="cl">add rule to allow exit_group
</span></span><span class="line"><span class="cl">add rule to allow getpid
</span></span><span class="line"><span class="cl">add rule to allow brk
</span></span><span class="line"><span class="cl">add rule to allow write upto <span class="m">512</span> bytes to fd <span class="m">1</span>
</span></span><span class="line"><span class="cl">add rule to allow write to any other fd except <span class="m">1</span>
</span></span><span class="line"><span class="cl">loading seccomp filter ...
</span></span></code></pre></div><p>inspecting the output one can look here that all the rules added to seccomp BPF folter with a process
ID since we have added the rule to allow getpid() system call .</p>
<p>open seccomp_bpf.c and add the following code to the end of the file</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/seccomp.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* &#34;mov al,42; ret&#34; aka &#34;return 42&#34; */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\xb0\x2a\xc3</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* spawn child process, connected by a pipe */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pipe</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* enter mode 1 seccomp and execute untrusted bytecode */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">prctl</span><span class="p">(</span><span class="n">PR_SET_SECCOMP</span><span class="p">,</span> <span class="n">SECCOMP_MODE_STRICT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* send result over pipe, and exit */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">syscall</span><span class="p">(</span><span class="n">SYS_exit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* read the result from the pipe, and print it */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;untrusted bytecode returned %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre tabindex="0"><code class="language-bsh" data-lang="bsh">$ suod gcc seccomp_bpf.c -o seccomp_bpf2 -lseccomp
$ ./seccomp_bpf2
initiating seccomp ...
add rule to allow exit_group
add rule to allow getpid
add rule to allow brk
add rule to allow write upto 512 bytes to fd 1
add rule to allow write to any other fd except 1
loading seccomp filter ...
this process is -9 
</code></pre><h2 id="seccomp-in-docker">seccomp in docker</h2>
<p>step 1. check the  SECCOMP is working and configured in docker daemon</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker info <span class="p">|</span> grep seccomp
</span></span></code></pre></div><p>step 2. check the seccomp profile of the container</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker inspect --format<span class="o">=</span><span class="s1">&#39;{{json .HostConfig.SecurityOpt}}&#39;</span> &lt;container_name&gt;
</span></span></code></pre></div><p>seccomp-profiles/deny.json</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;defaultAction&#34;</span><span class="p">:</span> <span class="s2">&#34;SCMP_ACT_ERRNO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;architectures&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X86_64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X86&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X32&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;syscalls&#34;</span> <span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>a docker seccomp profile consists of 3 required entries viz. defaultAction, architectures and syscalls. the possible action of precedence are</p>
<ul>
<li>SCMP_ACT_KILL
<ul>
<li>kill with am status of 0x80 + 31(SIGSYS) = 159</li>
</ul>
</li>
<li>SCMP_ACT_TRAP
<ul>
<li>send SIGSYS signal without executing the syscall</li>
</ul>
</li>
<li>SCMP_ACT_ERRNO
<ul>
<li>set erno withou executing the syscall</li>
</ul>
</li>
<li>SCMP_ACT_TRACE
<ul>
<li>invoke a ptrace to make a decision or set errno to Enosys</li>
</ul>
</li>
<li>SCMP_ACT_ALLOW
<ul>
<li>allow the syscall to execute</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>
docker run --security-opt seccomp=seccomp-profiles/deny.json -it ubuntu bash
</code></pre><p>using <code>--security-opt seccomp=seccomp-profiles/deny.json</code> we have set the seccomp profile to the container .
notice here that since not even single system call is allwoed , the docker container is not able to run .</p>
<p>create sc-custom.json</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;defaultAction&#34;</span><span class="p">:</span> <span class="s2">&#34;SCMP_ACT_ALLOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;architectures&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X86_64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X86&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;SCMP_ARCH_X32&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;syscalls&#34;</span> <span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;names&#34;</span><span class="p">:</span><span class="s2">&#34;mkdir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;action&#34;</span><span class="p">:</span> <span class="s2">&#34;SCMP_ACT_ALLOW&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;args::[]
</span></span></span><span class="line"><span class="cl"><span class="nt">        
</span></span></span><span class="line"><span class="cl"><span class="nt">        },
</span></span></span><span class="line"><span class="cl"><span class="nt">        {
</span></span></span><span class="line"><span class="cl"><span class="nt">            &#34;</span><span class="err">names</span><span class="s2">&#34;: &#34;</span><span class="err">chmod</span><span class="s2">&#34; ,
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;</span><span class="err">action</span><span class="s2">&#34;: &#34;</span><span class="err">SCMP_ACT_ERRNO</span><span class="s2">&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;</span><span class="err">args</span><span class="p">::[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>before going to run this commands see what
all system call actally take place while hitting mkdir command inside an alphine
container using strace</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -rm -it --security-opt <span class="nv">seccomp</span><span class="o">=</span>unconfined alphine sh 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apk add strace
</span></span><span class="line"><span class="cl">strace mkdir <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span></code></pre></div><p>we have installed strace utility inside the container and then run the mkdir command .the system call oberved include  <code>execve </code> ,
<code>arch_prtctl</code> <code> mprotect</code> <code>brk</code> <code>access</code> <code>openat</code> <code>mkdirat</code> <code>fstat</code> <code>close</code> <code>exit_group</code> . test directory is created inside the container .</p>
<p>Now run another contaiet with same aphine image with new <code>sc-custom.json</code> seccomp profile .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -rm -it --security-opt <span class="nv">seccomp</span><span class="o">=</span>sc-custom.json alphine sh 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ls 
</span></span><span class="line"><span class="cl">mkdir <span class="nb">test</span>
</span></span></code></pre></div><p>mkdir: can&rsquo;t create directory &rsquo;test&rsquo;: Operation not permitted</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># chmod /etc/</span>
</span></span></code></pre></div><p>clearly , the seccomp profile attavhed is blocking the mkdir and chmod system call .
lets comfirm it with strace utility agin</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apk add strace
</span></span><span class="line"><span class="cl">strace mkdir <span class="nb">test</span>
</span></span></code></pre></div><p>as expected the systm call got rejected with <code>Operation not permitted</code> error . since also we have added a deny condition for chmod system call .</p>
<p>Run a docker container with the same seccomp file with chmpd over file 777 permission</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker run -rm -it --security-opt <span class="nv">seccomp</span><span class="o">=</span>sc-custom.json alphine sh chmod <span class="m">777</span> /etc/passwd
</span></span></code></pre></div><p>this os also denyed by the seccomp profile .</p>
<p>for more play with <code>default.json</code> seccomp
profile available on moby github repo</p>
<h2 id="app-armor">app armor</h2>
<p>appArmor is a MAC (Mandatory Access Control) system that is used to restrict the access of a process to the system resources . its implements a task centered policy with task
&ldquo;profile&rdquo; being created and loaded from user space</p>
<p>tasks on the syste, that do not have profi;e defined for them run an uncofined state which  is equivalant to standared Linux DAC (Discretionary Access Control) . permissions .</p>
<p>appArmor works on file paths . it comes as default LSM for ubuntu and SUSE .</p>
<ol>
<li>let check our dpcler version and service status</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ docker version
</span></span><span class="line"><span class="cl">$ systemctl status docker 
</span></span></code></pre></div><ol start="2">
<li>check AppArmor in docker info</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker info -f <span class="s1">&#39;{{json .SecurityOptions}}&#39;</span>
</span></span></code></pre></div><ol start="3">
<li>chheck AppArmor status . it might required sudo access</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ apparmor_status
</span></span><span class="line"><span class="cl">$ sudo apparmor_status
</span></span></code></pre></div><p>this will provide us the infromation about all the profile loaded and the mode of profiles with process</p>
<p>the apparmor_status and aa-status can used interchangeably . just check if they are available with your system installation or not gernerally they comes in package call
<code>apparmor-utils</code> .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ which apparmor_status
</span></span><span class="line"><span class="cl">$ which aa-status
</span></span></code></pre></div><p>and one can gain insight about the number of profile also</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudp aa-status --help 
</span></span><span class="line"><span class="cl">$ sudo aa-status --enabled <span class="o">[</span>No error output means apparmor is enabled<span class="o">]</span>
</span></span><span class="line"><span class="cl">$ sudo aa-status --profiles <span class="o">[</span>prints the no of loaded policies <span class="o">]</span>
</span></span><span class="line"><span class="cl">$ sudo aa-status --enforce <span class="o">[</span>prints the no of enforced policies <span class="o">]</span>
</span></span></code></pre></div><p>Install an AppArmor Profile generator tool called <code>bane</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Export the sha256sum for verification.</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">BANE_SHA256</span><span class="o">=</span><span class="s2">&#34;e70b1d67333975eb705b08045de9558483daae05792a1ff28dcec28d4c164386&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Download and check the sha256sum.</span>
</span></span><span class="line"><span class="cl">$ curl -fSL <span class="s2">&#34;https://github.com/genuinetools/bane/releases/download/v0.4.4/bane-freebsd-amd64&#34;</span> -o <span class="s2">&#34;/usr/local/bin/bane&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BANE_SHA256</span><span class="si">}</span><span class="s2">  /usr/local/bin/bane&#34;</span> <span class="p">|</span> sha256sum -c - <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	<span class="o">&amp;&amp;</span> chmod a+x <span class="s2">&#34;/usr/local/bin/bane&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;bane installed!&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run it!</span>
</span></span><span class="line"><span class="cl">$ bane -h
</span></span></code></pre></div><p>get the sample TOML file for creation of AppArmor profile from bane Github</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo curl -o sample.toml https://raw.githubusercontent.com/genuinetools/bane/master/sample.toml
</span></span><span class="line"><span class="cl">$ ls 
</span></span></code></pre></div><p>the parts of the sample.toml file are</p>
<p>a. <code>name</code> key value pair is the name of the profile .</p>
<pre tabindex="0"><code># name of the profile, we will auto prefix with `docker-`
# so the final profile name will be `docker-nginx-sample`
Name = &#34;nginx-sample&#34;
</code></pre><p>b . <code>Filesystem </code> table with different arrays like ReadOnlyPaths , LogOnWritePaths , WritePaths , ReadPaths , NoAccessPaths , ReadOnlyPaths .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Filesystem<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># read only paths for the container</span>
</span></span><span class="line"><span class="cl"><span class="nv">ReadOnlyPaths</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/bin/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/boot/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/dev/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/etc/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/home/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/lib/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/lib64/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/media/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/mnt/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/opt/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/proc/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/root/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/sbin/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/srv/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/tmp/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/sys/**&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/usr/**&#34;</span>,
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># paths where you want to log on write</span>
</span></span><span class="line"><span class="cl"><span class="nv">LogOnWritePaths</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/**&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># paths where you can write</span>
</span></span><span class="line"><span class="cl"><span class="nv">WritablePaths</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/var/run/nginx.pid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># allowed executable files for the container</span>
</span></span><span class="line"><span class="cl"><span class="nv">AllowExec</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/usr/sbin/nginx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># denied executable files</span>
</span></span><span class="line"><span class="cl"><span class="nv">DenyExec</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/bin/dash&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/bin/sh&#34;</span>,
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;/usr/bin/top&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span></code></pre></div><p>C. Capabilties table allow array for allowing Linux capabilities .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="c"># allowed capabilities</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Capabilities</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">Allow</span> <span class="p">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;chown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;dac_override&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;setuid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;setgid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;net_bind_service&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>D . Network table with Raw , Packet , Protocols array .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Network</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c"># if you don&#39;t need to ping in a container, you can probably</span>
</span></span><span class="line"><span class="cl"><span class="c"># set Raw to false and deny network raw</span>
</span></span><span class="line"><span class="cl"><span class="nx">Raw</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="nx">Packet</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="nx">Protocols</span> <span class="p">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;tcp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;udp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="s2">&#34;icmp&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>build the sample file with bane and check apparmor status if this profile gets enforced</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo bane sample.toml
</span></span><span class="line"><span class="cl">$ sudo aa-status <span class="p">|</span> grep docker 
</span></span></code></pre></div><p>notice that there was already loaded <code>docker-default</code> profile .</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo ls /etc/apparmor.d/containers/
</span></span><span class="line"><span class="cl">docker-ngnix-sample
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cat /etc/apparmor.d/containers/docker-nginx-sample
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="cp">#include</span> <span class="cpf">&lt;tunables/global&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="n">profile</span> <span class="n">docker</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">sample</span> <span class="n">flags</span><span class="o">=</span><span class="p">(</span><span class="n">attach_disconnected</span><span class="p">,</span><span class="n">mediate_deleted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#include</span> <span class="cpf">&lt;abstractions/base&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="cp">#include</span> <span class="cpf">&lt;abstractions/nameservice&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="cp">#include</span> <span class="cpf">&lt;abstractions/openssl&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">      <span class="o">/</span><span class="n">bin</span><span class="cm">/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /boot/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /dev/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /etc/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /home/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /lib/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /lib64/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /media/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /mnt/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /opt/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /proc/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /root/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /sbin/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /srv/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /tmp/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /sys/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /usr/** r,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /var/run/nginx.pid rw,
</span></span></span><span class="line"><span class="cl"><span class="cm">      /usr/sbin/nginx ix,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny /bin/dash ix,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny /bin/sh ix,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny /usr/bin/top ix,
</span></span></span><span class="line"><span class="cl"><span class="cm">      capability chown,
</span></span></span><span class="line"><span class="cl"><span class="cm">      capability dac_override,
</span></span></span><span class="line"><span class="cl"><span class="cm">      capability setuid,
</span></span></span><span class="line"><span class="cl"><span class="cm">      capability setgid,
</span></span></span><span class="line"><span class="cl"><span class="cm">      capability net_bind_service,
</span></span></span><span class="line"><span class="cl"><span class="cm">      network raw,
</span></span></span><span class="line"><span class="cl"><span class="cm">      network packet,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny network raw,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny network packet,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny network tcp,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny network udp,
</span></span></span><span class="line"><span class="cl"><span class="cm">      deny network icmp,
</span></span></span><span class="line"><span class="cl"><span class="cm">    }
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">    .....
</span></span></span></code></pre></div><p>Apply the above bane generated profile to the container before that lets
analyze some commands that we can perfectly run within a container not attached to this profile</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker run -it --rm --name without-aa -p 4444:80 nginx bash 
</span></span><span class="line"><span class="cl"><span class="c1"># sh</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dash</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bash </span>
</span></span><span class="line"><span class="cl"><span class="c1"># exit</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exist </span>
</span></span></code></pre></div><p>in this ngnix container we are able to run many variants of shell like bash sh and dash without any error</p>
<p>now attach th profile and try to achive the same</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker run -it --rm --name with-aa --security-opt<span class="o">=</span><span class="s2">&#34;apparmor:docker-nginx-sample&#34;</span> -p 4444:80  nginx bash 
</span></span></code></pre></div><p>As expected, the attached AppArmor profile is not allowing us to spawn shells inside the container. This  is how an AppArmor profile can be attached to a Docker container using <code>--security-opt</code> and the different  executables and capabilities can be controlled.  Till now, we have seen that Docker uses many Linux technologies, such as Capabilities,  AppArmor and SecComp for defense. However, AppArmor can protect a Docker Host even  when the other lines of defense such as SecComp and Capabilities are not effective.  Remember that if you are not explicitly defining any AppArmor profile, the <code>default-docker</code>  AppArmor profile will get automatically attached. Until and unless <code>--security-opt  apparmor=unconfined</code> is not present during the container run command execution <code>default-docker</code>
apparmor profile will be remain loaded .</p>

      </div>
      








  
  
  
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

      
    
        

        
          
        

        
        


<footer id="article-footer">
  <time id="article-last-updated" datetime="2023-11-26"><i class="icon icon-calendar"></i>&nbsp;Last updated: 2023-11-26</time>

  
    <a id="article-prev-link" href="/containersecurity/static-analysis-of-container-images-library-for-container/"><i class="icon icon-prev icon-colored"></i> Prev</a>
  

  
    <a id="article-next-link"  href="/containersecurity/docker-daemon-security-configurations/">Next <i class="icon icon-next icon-colored"></i></a>
  
</footer>
    </article>
    <aside id="toc">
  <span class="btn-close"><i class="icon icon-close"></i></span>
  <div class="sticky">
    <strong><i class="icon icon-toc"></i> On this page</strong>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#seccomp-and-apparmor">SecComp and AppArmor</a></li>
    <li><a href="#seccomp">seccomp</a></li>
  </ul>

  <ul>
    <li><a href="#seccomp-exercise-1">SecComp Exercise 1</a></li>
    <li><a href="#seccomp-in-docker">seccomp in docker</a></li>
    <li><a href="#app-armor">app armor</a></li>
  </ul>
</nav>
  </div>
</aside>
  </main>
</div>

    <footer id="site-footer">
  
  <div id="site-footer-copyright">
    <a href="https://discord.gg/rEvr7vq" target="_blank">
      <i class="icon icon-copyright"></i> 2023 CloudNativeFolks
    </a>
  </div>

  
  <div id="site-footer-social">

    

    
    <a href="https://twitter.com/i/communities/1499311438745468931" target="_blank" aria-label="twitter url">
      <i class="icon icon-twitter icon-colored"></i>
    </a>
    

    
    <a href="https://github.com/sangam14" target="_blank" aria-label="github url">
      <i class="icon icon-github icon-colored"></i>
    </a>
    

    
    <a href="https://www.youtube.com/@CloudNativeFolks" target="_blank" aria-label="youtube url">
      <i class="icon icon-youtube icon-colored"></i>
    </a>
    

  </div>

  
  <center> <a href="https://visitorbadge.io/status?path=https%3A%2F%2Fkubedaily.com"><img src="https://api.visitorbadge.io/api/visitors?path=https%3A%2F%2Fkubedaily.com&label=KubeDaily&labelColor=%232ccce4&countColor=%2337d67a" /></a> </center> 

  
  <div id="site-footer-love">
    Made with <i class="icon icon-love icon-colored"></i> &nbsp;from&nbsp;<a href="https://blog.cloudnativefolks.org" target="_blank">@CloudNativeFollks</a>
  </div>
</footer>
    






<script type="text/javascript" src="/js/base.min.js"></script>



  
  <script src="/js/component/docsearch.min.js"></script>
  <script type="application/javascript">
      docsearch({
          container: '#site-header-search',
          appId: '',
          indexName: '',
          apiKey: '',
      });
  </script>


<script type="application/javascript">
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js?2023-12-03')
            .catch(function(err) {console.error('ServiceWorker registration failed: ', err);});
    }
</script>
  </body>
</html>